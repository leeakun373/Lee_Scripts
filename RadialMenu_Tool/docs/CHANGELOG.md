# 更新日志

## [1.1.9] - 2025-01-XX

### 新增功能
- 🎛️ **子菜单布局参数化**：新增独立的子菜单尺寸和布局参数控制
  - 子菜单窗口尺寸（宽度/高度）独立于按钮参数
  - 子菜单按钮间距可调（1-10 像素）
  - 子菜单窗口内边距可调（2-15 像素）
  - 所有参数在 Setup 界面左侧列提供滑轨控制

### 改进
- 🎨 **子菜单尺寸独立化**：子菜单窗口尺寸与按钮尺寸完全解耦
  - 子菜单尺寸使用独立参数 `submenu_width` 和 `submenu_height`
  - 按钮尺寸使用独立参数 `slot_width` 和 `slot_height`
  - 两者互不影响，提供更灵活的布局控制
- 🌐 **多语言适配完善**：修复子菜单相关参数的多语言支持
  - 添加子菜单按钮尺寸、布局参数的中英文翻译
  - 修复硬编码中文文本，确保所有 UI 元素支持语言切换

### 修复
- 🐛 **Setup UI 显示问题**：修复新增参数在 Setup 界面不显示的问题
  - 添加表格标志，确保表格正确渲染和调整大小
- 🐛 **子菜单按钮溢出**：修复按钮超出子菜单边界的问题
  - 添加边界检查，确保按钮位置在子菜单内容区域内
  - 统一子菜单宽度计算逻辑，避免不一致导致的溢出

### 技术改进
- 🔧 **代码优化**：统一子菜单尺寸计算逻辑
  - `list_view.lua` 和 `submenu_bake_cache.lua` 使用一致的尺寸计算
  - 支持独立子菜单尺寸参数，向后兼容自动计算模式

## [1.1.8] - 2025-12-19

### 新增功能
- 🌐 **完整国际化支持**：添加中英文双语切换功能
  - 所有UI文本、按钮、提示信息均已国际化
  - 语言设置持久化保存
  - 切换语言时自动更新扇区名称（匹配默认模式）

### 性能优化
- ⚡ **ListClipper 高性能列表渲染**：Action 和 FX 浏览器使用 ListClipper 进行虚拟滚动
  - 仅渲染可见区域的项目，大幅提升长列表性能
  - 使用 ValidatePtr 验证 ListClipper 有效性，避免频繁创建
- ⚡ **预览区域缓存机制**：基于签名的缓存失效检测
  - 仅在配置变更时重新生成预览，减少不必要的重绘
- ⚡ **文本行缓存**：轮盘渲染时缓存文本行，提升绘制性能

### 修复
- 🐛 **按钮失效问题**：修复切换语言后按钮失效的问题
  - 所有按钮使用固定ID（##前缀），避免文本变化导致ID变化
- 🐛 **弹窗ID匹配问题**：修复新建预设和重命名预设弹窗无法打开的问题
  - OpenPopup 和 BeginPopupModal 使用完全匹配的ID
  - 修复弹窗打开逻辑，确保正确触发
- 🐛 **国际化文本缺失**：补充所有缺失的英文翻译
  - 工具提示、错误消息、弹窗标题等全部国际化
- 🐛 **窗口大小变化**：修复切换语言时窗口大小变化的问题
  - 使用固定窗口标题，避免因标题长度变化导致窗口调整

### 改进
- 🎨 **UI稳定性提升**：切换语言时自动关闭所有弹窗，避免状态混乱
- 🎨 **预设管理改进**：改进错误处理和用户反馈
- 🎨 **代码质量**：统一代码风格，改进注释和文档

## [1.1.7] - 2025-12-18

### 维护
- 🔄 版本号更新和维护

## [1.1.6] - 2025-12-18

### 改进
- 🧩 **Preset System 2.0（UI 回归紧凑风格）**：预设管理栏回到 1.1.5 的 Combo + 小按钮布局，减少界面结构变化但保留新功能
  - 新建预设弹窗支持：**创建空白** / **复制当前（从已保存配置）**
  - 新增 **重命名** 按钮（Default 保护、重名保护）

### 修复
- 🪟 **弹窗“飞走/无限变宽”**：弹窗改为 AlwaysAutoResize + 固定输入框宽度，并在出现时居中
- 🖊️ **重命名体验**：打开重命名弹窗时输入框默认填入当前预设名，并尽量自动全选；确认/取消按钮居中对齐

## [1.1.5] - 2025-12-17

### 重构
- 🧱 **项目结构调整**：运行时与设置编辑器进一步模块化拆分
  - 新增 `src/runtime/*`（controller/draw/anim/perf/input/config_reload 等）
  - 设置编辑器整理为 `src/settings/controller.lua` + `src/settings/{state,ops}.lua`
  - 设置标签页移动到 `src/settings/tabs/*`
- 🧭 **require 命名规范化**：统一使用 `gui.* / logic.* / runtime.* / settings.*`，降低撞名与阅读成本
- 🧹 **兼容入口保留**：`src/main_runtime.lua` 与 `src/main_settings.lua` 作为薄封装转发到新 controller

### 修复
- 🐛 **长按/松开热键回归修复**：修正“执行后关闭 UI 但仍按住触发键”场景下的按键释放判断，避免长按时误判松开导致的重复触发/关闭异常
- 🧹 **清理残留模块**：移除拆分后无引用的旧文件（`src/logic/fx_engine.lua`、`src/logic/search.lua`、`src/runtime/state.lua`）

## [1.1.3] - 2025-01-20

### 维护
- 🔄 版本号更新和维护

## [1.1.2] - 2025-12-14

### 改进
- 🎨 **UI 优化**：
  - 优化属性编辑栏（Inspector）布局，采用紧凑型头部设计
  - 改进按钮逻辑：智能显示"清除"和"删除"按钮（删除按钮仅在插槽数>9时显示）
  - 优化按钮对齐方式，使用右对齐布局
  - 改进工具提示显示
- 🔧 **代码优化**：
  - 优化网格编辑器（Grid）代码结构
  - 改进资源浏览器（Browser）功能
  - 优化设置界面（Settings）代码组织
  - 改进配置管理器逻辑
- 📝 **文档更新**：
  - 更新 Markers 相关文档
  - 优化代码注释和说明

### 修复
- 🐛 修复 Markers 相关工具的小问题
- 🐛 改进代码格式和换行符处理

## [1.1.1] - 2024-12-20

### 改进
- 🧠 **智能上下文检测升级**：
  - 完美复刻 Reaper 原生 "Insert FX" 的上下文判断逻辑。
  - 解决了在 ImGui 窗口点击导致焦点丢失，从而误判操作对象的问题。
  - 引入了 `last_valid_context` 状态追踪，精准识别用户最后操作的是 Track 面板 (TCP/MCP) 还是 Arrange View (Items)。
- ✨ **批量操作支持**：
  - 支持对批量选中的 Items 或 Tracks 添加 FX/Chain。
  - 智能识别：如果是混合选中（既有 Track 也有 Item），会根据用户的最后一步操作意图（点击 TCP 或框选 Item）来决定应用给哪一方。

## [1.1.0] - 2024-12-20

### 新增功能
- ✨ 添加 Chain（效果链）类型支持 - 可在类型菜单中选择，行为与 FX 相同
- ✨ 添加 Template（轨道模板）类型支持 - 可在类型菜单中选择

### 修复问题
- 🐛 修复轮盘拖拽功能失效的问题 - 恢复手动拖拽检测机制
- 🐛 修复子菜单点击后闪烁消失的问题 - 改进子菜单悬停检测逻辑
- 🐛 修复点击子菜单外位置导致子菜单意外关闭的问题 - 优化点击检测逻辑

### 改进
- 🎨 移除未使用的 Script 类型 - 简化类型选项
- 🎨 移除插槽描述字段 - 简化界面，直接使用插槽名称
- 🏗️ 重构设置界面代码结构 - 将 2161 行的 main_settings.lua 拆分为多个模块化组件
  - `tab_preview.lua` - 预览面板模块
  - `tab_grid.lua` - 网格编辑器模块
  - `tab_inspector.lua` - 属性编辑栏模块
  - `tab_browser.lua` - 资源浏览器模块
  - `tab_presets.lua` - 预设管理模块
- 📦 改进代码可维护性 - 每个模块独立维护，AI 友好性提升

### 技术改进
- 🔧 优化拖拽检测逻辑 - 使用 IsItemActive + IsMouseDragging + 距离阈值
- 🔧 改进子菜单悬停检测 - 添加活动项检测，确保点击按钮时窗口保持悬停状态
- 🔧 统一状态管理 - 使用中央 state 对象管理所有共享状态

## [1.0.0] - 2024-12-09

### 新增功能
- ✨ 完整的轮盘菜单系统
- ✨ 可视化设置编辑器
- ✨ 支持 Actions、FX、Chains、Templates
- ✨ 拖拽功能（从浏览器拖放到插槽）
- ✨ 内部网格交换（拖拽插槽进行重新排列）
- ✨ 悬停打开/点击打开模式
- ✨ Pin 模式（固定菜单窗口）
- ✨ FX 浏览器（分类过滤：All, VST, VST3, JS, AU, CLAP, LV2, Chain, Template）
- ✨ 智能上下文检测（自动判断添加到 Track 还是 Item）
- ✨ 精致的 UI 设计（深色主题）

### 改进
- 🎨 优化预览区域（移除底部大红按钮，添加精致悬浮按钮）
- 🎨 改进网格视觉对比（已配置按钮更亮，空插槽更暗）
- 🎨 紧凑的 FX 浏览器布局
- 🐛 修复拖拽反馈可见性问题（使用 Tooltip 防止被窗口裁切）
- 🐛 修复拖拽与悬停打开逻辑冲突
- 🐛 修复子菜单点击时意外关闭的问题
- 🐛 修复 Item 和 Track 检测逻辑（使用 GetItemFromPoint）
- 🔇 静默模式（移除所有控制台输出）

### 技术改进
- 📦 模块化架构（GUI/Logic/Data 清晰分离）
- 📦 高性能列表渲染（使用 ListClipper）
- 📦 缓存机制（FX、Chains、Templates）
- 📦 完整的错误处理

### 文档
- 📚 完整的 README.md
- 📚 实现文档和开发笔记
- 📚 GitHub 上传指南


